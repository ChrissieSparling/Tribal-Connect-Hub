{% extends "layout.html" %}

{% block title %}Share Event Photos{% endblock %}
{% block content %}

<a href="/tribes-html" class="muted">← Back</a>
<h1>Share Photos</h1>
<p class="muted">Upload event photos. Choose visibility: <b>Public</b>, <b>Tribal-only</b>, or <b>City-only</b>.</p>

<form id="up" enctype="multipart/form-data" aria-describedby="form-help">
  <p id="form-help" class="sr-only">Upload a photo, optionally add a caption and your name, then choose who can see it.
  </p>

  <div class="mb-2">
    <label for="fileInput">Photo file</label>
    <input type="file" id="fileInput" name="file" required>
  </div>

  <div class="mb-2">
    <label class="sr-only" for="captionInput">Caption</label>
    <input type="text" id="captionInput" name="caption" placeholder="Caption (optional)"
      aria-label="Caption (optional)">
  </div>

  <div class="mb-2">
    <label class="sr-only" for="uploaderInput">Your name</label>
    <input type="text" id="uploaderInput" name="uploader_name" placeholder="Your name (optional)"
      aria-label="Your name (optional)">
  </div>

  <div class="mb-2">
    <label for="visibilitySelect">Visibility</label>
    <select name="visibility" id="visibilitySelect" required>
      <option value="public">Public</option>
      <option value="tribal_only">Tribal-only</option>
      <option value="city_only" disabled>City-only (coming soon)</option>
    </select>
  </div>

  <button type="submit" class="btn btn-primary">Upload</button>
  <span id="msg" class="muted text-small" role="status" aria-live="polite"></span>
</form>

<h3 class="mt-1">Gallery</h3>
<div id="gallery" class="grid"></div>

{% endblock %}

{% block scripts %}
<script>
  const eventId = window.location.pathname.split('/').slice(-2, -1)[0];

  async function loadGallery() {
    const r = await fetch(`/api/core/events/${eventId}/media`);
    const list = r.ok ? await r.json() : [];
    document.getElementById('gallery').innerHTML = (list || []).map(m => `
      <div class="card-media">
        <img src="${m.file_path}" alt="${(m.caption || 'Event photo').replace(/"/g,'&quot;')}" class="img-cover">
        ${m.caption ? `<div class="mt-1">${m.caption}</div>`:''}
        <div class="muted text-small">${m.visibility}${m.uploader_name ? ` • ${m.uploader_name}`:''}</div>
      </div>
    `).join('') || '<em class="muted">No photos yet</em>';
  }

  document.getElementById('up').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('msg');
    msg.textContent = 'Uploading…';
    try {
      const form = new FormData(e.currentTarget);
      const r = await fetch(`/api/core/events/${eventId}/media`, {
        method: 'POST',
        body: form
      });
      if (!r.ok) {
        msg.textContent = 'Upload failed';
        return;
      }
      msg.textContent = 'Uploaded ✔';
      e.currentTarget.reset();
      loadGallery();
    } catch {
      msg.textContent = 'Upload failed';
    }
  });

  loadGallery();
</script>
{% endblock %}