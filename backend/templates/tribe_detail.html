{% extends "layout.html" %}
{% block title %}Tribe Details{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', path=
'css/styles.css') }}">
<style>
  .meta {
    color: #444;
    margin: .15rem 0;
  }

  .back {
    margin-bottom: 1rem;
    display: inline-block;
  }

  .spaced-hr {
    margin: 1.5rem 0;
  }

  .controls {
    display: flex;
    gap: .5rem;
    margin-top: .35rem;
    flex-wrap: wrap;
  }

  .qr {
    width: 64px;
    height: 64px;
    border-radius: 8px;
    margin-top: .25rem;
  }
</style>
{% endblock %}

{% block content %}
<a class="back" href="/tribes-html">← Back to Tribes</a>
<h1 id="name">Loading…</h1>
<div id="meta"></div>
<p id="desc"></p>

<hr class="spaced-hr">
<hr class="divider">

<h2>Events</h2>
<div id="events-list"><em>Loading…</em></div>

<h3 class="mt-1">Add Event</h3>
<form id="add-event">
  <label>Title</label>
  <input name="title" type="text" required title="Event Title">

  <label>Start Date</label>
  <input name="start_date" type="date" required title="Start Date">

  <label>End Date (optional)</label>
  <input name="end_date" type="date" title="End Date">

  <label>Location (optional)</label>
  <input name="location" type="text" placeholder="Enter location" title="Location">

  <label>Description (optional)</label>
  <textarea name="description" rows="2" title="Description" placeholder="Enter event description"></textarea>
  <a href="/events-html/{{ event.id }}/share">Share Photos</a>

  <div class="controls">
    <button type="submit">Add</button>
    <span id="ev-msg" class="meta"></span>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tribeId = window.location.pathname.split('/').pop();
    const fmt = (s) => s ? s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '';

    // ---------- Tribe header (fallback: in-memory -> core) ----------
    async function loadTribe() {
      const nameEl = document.getElementById('name');
      const metaEl = document.getElementById('meta');
      const descEl = document.getElementById('desc');

      let r;
      try {
        // Try in-memory first
        r = await fetch(`/tribes/${tribeId}`);
        if (!r.ok) {
          // Fallback to Core DB
          r = await fetch(`/api/core/tribes/${tribeId}`);
        }
      } catch (e) {
        // network or other error
      }

      if (!r || !r.ok) {
        nameEl.textContent = 'Tribe not found';
        metaEl.innerHTML = '';
        descEl.textContent = '';
        return;
      }

      const t = await r.json();
      nameEl.textContent = t.name || `Tribe #${tribeId}`;
      descEl.textContent = t.description || '';

      const bits = [];
      if (t.established_year) bits.push(
        `<div class="meta"><strong>Established:</strong> ${t.established_year}</div>`);
      if (t.recognition_type) bits.push(
        `<div class="meta"><strong>Recognition:</strong> ${fmt(t.recognition_type)}</div>`);
      if (t.original_territory_note) bits.push(
        `<div class="meta"><strong>Territory:</strong> ${t.original_territory_note}</div>`);
      if (t.website_url) bits.push(
        `<div class="meta"><strong>Website:</strong> <a href="${t.website_url}" target="_blank" rel="noopener">${t.website_url}</a></div>`
      );
      metaEl.innerHTML = bits.join('');
    }

    // ---------- Events list (fallback: in-memory -> core) ----------
    async function loadEvents() {
      const box = document.getElementById('events-list');

      let r;
      try {
        // Try in-memory first
        r = await fetch(`/tribes/${tribeId}/events`);
        if (!r.ok) {
          // Fallback to Core DB events
          r = await fetch(`/api/core/tribes/${tribeId}/events`);
        }
      } catch (e) {
        // ignore and show empty
      }

      if (!r || !r.ok) {
        box.innerHTML = '<em>No events yet.</em>';
        return;
      }

      let list = [];
      try {
        list = await r.json();
      } catch {
        box.innerHTML = '<em>No events yet.</em>';
        return;
      }

      if (!Array.isArray(list) || list.length === 0) {
        box.innerHTML = '<em>No events yet.</em>';
        return;
      }

      // Optional details (from core only) — ignore 404s
      const details = await Promise.all(list.map(async (e) => {
        try {
          const d = await fetch(`/api/core/events/${e.id}/details`);
          return d.ok ? await d.json() : null;
        } catch {
          return null;
        }
      }));

      box.innerHTML = list.map((e, i) => renderEvent(e, details[i])).join('');
    }

    function renderEvent(e, d) {
      const start = new Date(e.start_date);
      const end = e.end_date ? new Date(e.end_date) : null;
      const when = end ? `${start.toLocaleDateString()} – ${end.toLocaleDateString()}` : start.toLocaleDateString();

      const externalLink = d && d.external_url ?
        `<a href="${d.external_url}" target="_blank" rel="noopener">Event website</a>` : '';
      const weatherLink = (d && d.lat && d.lon) ?
        `<a href="https://forecast.weather.gov/MapClick.php?lat=${d.lat}&lon=${d.lon}" target="_blank" rel="noopener">Weather</a>` :
        '';
      const carpoolLink = d && d.carpool_url ?
        `<a href="${d.carpool_url}" target="_blank" rel="noopener">Carpool</a>` : '';
      const parking = d && d.parking_info ? `<div class="meta"><strong>Parking:</strong> ${d.parking_info}</div>` :
        '';
      const shuttle = d && d.shuttle_info ? `<div class="meta"><strong>Shuttle:</strong> ${d.shuttle_info}</div>` :
        '';

      return `
      <div class="meta event-item">
        <strong>${e.title}</strong>
        — ${when}${e.location ? ` • ${e.location}` : ''}
        ${e.description ? `<div>${e.description}</div>` : ''}

        ${parking}${shuttle}

        <div class="controls">
          <a href="/events-html/${e.id}/share">Share photos</a>
          ${externalLink ? `<span>• ${externalLink}</span>` : ''}
          ${weatherLink ? `<span>• ${weatherLink}</span>` : ''}
          ${carpoolLink ? `<span>• ${carpoolLink}</span>` : ''}
        </div>

        <div class="meta"><img class="qr" src="/api/core/events/${e.id}/share_qr.png" alt="Share QR"></div>

        <div class="controls">
          <button onclick="startEditEvent(${e.id})" type="button">Edit</button>
          <button onclick="deleteEvent(${e.id})" type="button">Delete</button>
        </div>

        <div id="edit-${e.id}" class="edit-container"></div>
      </div>
    `;
    }

    // ----- Edit/Delete handlers (core API) -----
    window.deleteEvent = async (id) => {
      if (!confirm('Delete this event?')) return;
      const r = await fetch(`/api/core/events/${id}`, {
        method: 'DELETE'
      });
      if (!r.ok && r.status !== 204) {
        alert('Failed to delete');
        return;
      }
      loadEvents();
    };

    window.startEditEvent = async (id) => {
      const r = await fetch(`/api/core/events/${id}`);
      if (!r.ok) {
        alert('Cannot load event');
        return;
      }
      const e = await r.json();
      const div = document.getElementById(`edit-${id}`);
      div.classList.add('is-open');
      div.innerHTML = `
      <form onsubmit="return saveEvent(${id}, this)">
        <label>Title</label>
        <input name="title" type="text" value="${e.title||''}">
        <label>Start Date</label>
        <input name="start_date" type="date" value="${e.start_date}">
        <label>End Date</label>
        <input name="end_date" type="date" value="${e.end_date||''}">
        <label>Location</label>
        <input name="location" type="text" value="${e.location||''}">
        <label>Description</label>
        <textarea name="description" rows="2">${e.description||''}</textarea>
        <div class="controls">
          <button type="submit">Save</button>
          <button type="button" onclick="cancelEditEvent(${id})">Cancel</button>
        </div>
      </form>
    `;
    };

    window.cancelEditEvent = (id) => {
      const div = document.getElementById(`edit-${id}`);
      div.classList.remove('is-open');
      div.innerHTML = '';
    };

    window.saveEvent = async (id, form) => {
      const data = Object.fromEntries(new FormData(form).entries());
      if (!data.title) delete data.title;
      if (!data.start_date) delete data.start_date;
      if (data.end_date === '') delete data.end_date;
      if (data.location === '') delete data.location;
      if (data.description === '') delete data.description;

      try {
        const r = await fetch(`/api/core/events/${id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        if (!r.ok) {
          const err = await r.json().catch(() => ({
            detail: r.statusText
          }));
          throw new Error(err.detail || 'Failed to update');
        }
        cancelEditEvent(id);
        loadEvents();
      } catch (e) {
        alert(e.message);
      }
      return false;
    };

    // ----- Add new event (core API) -----
    const addForm = document.getElementById('add-event');
    const msgEl = document.getElementById('ev-msg');
    if (addForm) {
      addForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (msgEl) msgEl.textContent = 'Saving…';

        const data = Object.fromEntries(new FormData(addForm).entries());
        if (data.end_date === '') delete data.end_date;
        if (data.location === '') delete data.location;
        if (data.description === '') delete data.description;

        try {
          const r = await fetch(`/api/core/tribes/${tribeId}/events`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          if (!r.ok) {
            const err = await r.json().catch(() => ({
              detail: r.statusText
            }));
            throw new Error(err.detail || 'Failed to create event');
          }
          if (typeof addForm.reset === 'function') addForm.reset();
          if (msgEl) msgEl.textContent = 'Added ✔';
          loadEvents();
        } catch (err) {
          if (msgEl) msgEl.textContent = err.message;
          console.error(err);
        }
      });
    }

    // Kick off
    loadTribe();
    loadEvents();
  });
</script>
{% endblock %}