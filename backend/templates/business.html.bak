{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-md-7">
      <h2 class="mb-2">{{ business.name }}</h2>
      <p>{{ business.description }}</p>

      <h5 class="mt-4">Compliance & Legal</h5>
      <ul>
        {% for c in compliance %}
        <li><strong>{{ c.key }}:</strong> {{ c.value }}</li>
        {% endfor %}
      </ul>
      {% if legal_links %}
      <ul>
        {% for l in legal_links %}
        <li><a href="{{ l.url }}" target="_blank" rel="noopener">{{ l.label }}</a></li>
        {% endfor %}
      </ul>
      {% endif %}

      <h5 class="mt-4">Community Reviews {% if avg_rating %}<span class="badge bg-success">Avg
          {{ avg_rating }}</span>{% endif %}</h5>
      {% if reviews %}
      {% for r in reviews %}
      <div class="border rounded p-3 mb-2">
        <strong>{{ r.title }}</strong> — {{ r.rating }}/5
        <div class="text-muted small">{{ r.created_at }}</div>
        <div>{{ r.body }}</div>
      </div>
      {% endfor %}
      {% else %}
      <p>No reviews yet.</p>
      {% endif %}

      <form class="mt-3" id="review-form">
        <h6>Add a Review</h6>
        <input class="form-control mb-2" name="title" placeholder="Title" required>
        <textarea class="form-control mb-2" name="body" placeholder="Your experience" required></textarea>
        <label for="review-rating" class="form-label">Rating (1-5)</label>
        <input id="review-rating" class="form-control mb-2" name="rating" type="number" min="1" max="5" value="5"
          required placeholder="Enter rating from 1 to 5">
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>

      <h5 class="mt-4">Clothing Fit & Cultural Notes</h5>
      {% if size_feedback %}
      {% for s in size_feedback %}
      <div class="border rounded p-3 mb-2">
        <div class="small text-muted">{{ s.created_at }}</div>
        <div><strong>{{ s.product_name or 'Product' }}</strong> — Fit scale: {{ s.fit_scale }} (-2 small … +2 large)
        </div>
        {% if s.usual_size or s.purchased_size %}
        <div>Usual size: {{ s.usual_size }} | Purchased: {{ s.purchased_size }}</div>
        {% endif %}
        {% if s.fit_notes %}<div>{{ s.fit_notes }}</div>{% endif %}
        {% if s.culture_notes %}<div class="mt-1"><em>Cultural:</em> {{ s.culture_notes }}</div>{% endif %}
      </div>
      {% endfor %}
      {% else %}
      <p>No size feedback yet.</p>
      {% endif %}

      <form class="mt-2" id="size-form">
        <input class="form-control mb-2" name="product_name" placeholder="Product name (optional)">
        <div class="row g-2">
          <div class="col"><input class="form-control" name="usual_size" placeholder="Your usual size"></div>
          <div class="col"><input class="form-control" name="purchased_size" placeholder="Purchased size"></div>
        </div>
        <textarea class="form-control my-2" name="fit_notes"
          placeholder="Fit notes (e.g., chest tight, sleeves long)"></textarea>
        <label class="form-label" for="fit-scale-range">Fit scale (-2 small … +2 large)</label>
        <input id="fit-scale-range" class="form-range" name="fit_scale" type="range" min="-2" max="2" value="0"
          title="Select fit scale from -2 (small) to +2 (large)" placeholder="-2 (small) to +2 (large)">
        <textarea class="form-control my-2" name="culture_notes"
          placeholder="Cultural significance (story, pattern, practice)"></textarea>
        <button type="submit" class="btn btn-outline-primary">Submit</button>
      </form>
    </div>
    <div class="col-md-5">
      <div id="gallery" class="mb-3">
        {% if media %}
        {% for m in media %}
        <img class="img-fluid mb-2 rounded" src="{{ m.url }}" alt="{{ m.caption }}">
        {% endfor %}
        {% else %}
        <div class="alert alert-info">No photos yet.</div>
        {% endif %}
      </div>
      <div class="card">
        <div class="card-body">
          <h6>Contact</h6>
          {% if business.website %}<div><a href="{{ business.website }}" target="_blank">Website</a></div>{% endif %}
          {% if business.email %}<div>Email: {{ business.email }}</div>{% endif %}
          {% if business.phone %}<div>Phone: {{ business.phone }}</div>{% endif %}
          <div class="small text-muted mt-2">{{ business.street }} {{ business.city }} {{ business.state }}
            {{ business.postal_code }}</div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  const postJSON = async (url, data) => {
    const r = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });
    return await r.json();
  }
  document.getElementById('review-form') ? .addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    data.rating = parseInt(data.rating, 10);
    const res = await postJSON('/api/b/{{ business.slug }}/reviews', data);
    alert('Review submitted for moderation.');
    location.reload();
  });
  document.getElementById('size-form') ? .addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    data.fit_scale = parseInt(data.fit_scale, 10);
    const res = await postJSON('/api/b/{{ business.slug }}/size-feedback', data);
    alert('Thanks for your fit & cultural notes!');
    location.reload();
  });
</script>
{% endblock %}