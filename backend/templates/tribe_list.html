{% block title %}Tribes • Tribal Connect Hub{% endblock %}

{% block content %}
<section class="tribes" role="region" aria-labelledby="tribe-title">
  <h2 id="tribe-title" class="h4">Participating Tribes</h2>
  <p class="text-muted">Browse participating tribes and view public info.</p>

  <div class="toolbar mb-3">
    <div>
      <label class="sr-only" for="q">Search tribes by name</label>
      <input id="q" type="text" class="form-control" placeholder="Search by name…" aria-label="Search tribes by name">
    </div>

    <div>
      <label class="sr-only" for="sort">Sort tribes</label>
      <select id="sort" name="sort" class="form-select" aria-label="Sort tribes">
        <option value="name_asc">Name (A→Z)</option>
        <option value="name_desc">Name (Z→A)</option>
        <option value="established_desc">Established (newest)</option>
        <option value="established_asc">Established (oldest)</option>
      </select>
    </div>

    <button id="clear" type="button" class="btn btn-outline-secondary">Clear</button>
    <span id="status" class="text-muted" role="status" aria-live="polite"></span>
  </div>

  <ul id="list" class="item-list">
    <li class="text-muted">Loading…</li>
  </ul>
</section>
{% endblock %}

{% block scripts %}
<script>
  const fmt = (s) => s ? s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '';
  let TRIBES = [];

  async function load() {
    const list = document.getElementById('list');
    const status = document.getElementById('status');
    list.innerHTML = '<li class="text-muted">Loading…</li>';
    status.textContent = '';

    try {
      const q = document.getElementById('q').value.trim();
      const sort = document.getElementById('sort').value;

      const params = new URLSearchParams();
      if (q) params.set('q', q);
      params.set('sort', sort);
      params.set('limit', 500);

      let r;
      try {
        r = await fetch(`/tribes?${params.toString()}`);
        if (!r.ok) {
          r = await fetch(`/api/core/tribes?${params.toString()}`);
        }
      } catch (e) {
        // ignore to handle below
      }
      if (!r || !r.ok) throw new Error('Unable to load tribes');
      TRIBES = await r.json();

      render();
      status.textContent = `${TRIBES.length} tribe${TRIBES.length===1?'':'s'} found`;
    } catch (e) {
      list.innerHTML = '<li class="text-danger">Unable to load tribes. Please try again later.</li>';
    }
  }

  function render() {
    const list = document.getElementById('list');
    if (!Array.isArray(TRIBES) || TRIBES.length === 0) {
      list.innerHTML = '<li class="text-muted">No tribes found.</li>';
      return;
    }

    list.innerHTML = TRIBES.map(t => `
      <li class="item">
        <a class="item-link" href="/tribes-html/${t.id}">
          <strong>${t.name}</strong>
        </a>
        ${t.description ? `<div class="item-desc">${t.description}</div>` : ``}
        <div class="badges">
          ${t.recognition_type ? `<span class="badge-chip">${fmt(t.recognition_type)}</span>` : ``}
          ${t.established_year ? `<span class="badge-chip">Est. ${t.established_year}</span>` : ``}
        </div>
      </li>
    `).join('');
  }

  document.getElementById('q').addEventListener('input', load);
  document.getElementById('sort').addEventListener('change', load);
  document.getElementById('clear').addEventListener('click', () => {
    document.getElementById('q').value = '';
    load();
  });

  load();
</script>
{% endblock %}