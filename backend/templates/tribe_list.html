{% extends "base.html" %}

{% block head_extra %}
<style>
  .item-list { list-style:none; padding:0; margin: 1rem 0; }
  .item { padding: .75rem 0; border-bottom: 1px solid #eee; }
  .item-link { text-decoration:none; color:inherit; }
  .item-desc { color:#444; margin:.25rem 0; }
  .badges { display:flex; gap:.35rem; flex-wrap:wrap; margin-top:.25rem; }
  .badge { background:#f3f4f6; color:#111; border-radius: 999px; padding:.15rem .5rem; font-size:.8rem; }
  .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .muted { color:#666; font-size:.9rem; }
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">Tribes</h1>
<p class="muted">Browse participating tribes and view public info.</p>

<div class="toolbar">
  <input id="q" type="text" placeholder="Search by name…" >
  <select id="sort">
    <option value="name_asc">Sort: Name (A→Z)</option>
    <option value="name_desc">Sort: Name (Z→A)</option>
    <option value="established_desc">Sort: Established (newest)</option>
    <option value="established_asc">Sort: Established (oldest)</option>
  </select>
  <button id="clear" type="button">Clear</button>
  <span id="status" class="muted"></span>
</div>

<ul id="list" class="item-list"><li class="muted">Loading…</li></ul>
{% endblock %}

{% block scripts %}
<script>
  const fmt = (s) => s ? s.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase()) : '';
  let TRIBES = [];

  async function load() {
    const list = document.getElementById('list');
    const status = document.getElementById('status');
    list.innerHTML = '<li class="muted">Loading…</li>';
    status.textContent = '';

    try {
      // Pull from Core DB (this has your 30 seeded tribes)
      const q = document.getElementById('q').value.trim();
      const sort = document.getElementById('sort').value;

      const params = new URLSearchParams();
      if (q) params.set('q', q);
      params.set('sort', sort);
      params.set('limit', 500);

      const r = await fetch(`/api/core/tribes?${params.toString()}`);
      if (!r.ok) throw new Error('Failed to load tribes');
      TRIBES = await r.json();

      render();
    } catch (e) {
      list.innerHTML = `<li class="muted" style="color:#b00020">Error: ${e.message}</li>`;
    }
  }

  function render() {
    const list = document.getElementById('list');
    if (!Array.isArray(TRIBES) || TRIBES.length === 0) {
      list.innerHTML = '<li class="muted">No tribes found.</li>';
      return;
    }

    list.innerHTML = TRIBES.map(t => `
      <li class="item">
        <a class="item-link" href="/tribes-html/${t.id}">
          <strong>${t.name}</strong>
        </a>
        ${t.description ? `<div class="item-desc">${t.description}</div>` : ``}
        <div class="badges">
          ${t.recognition_type ? `<span class="badge">${fmt(t.recognition_type)}</span>` : ``}
          ${t.established_year ? `<span class="badge">Est. ${t.established_year}</span>` : ``}
        </div>
      </li>
    `).join('');
  }

  // UI bindings
  document.getElementById('q').addEventListener('input', () => load());
  document.getElementById('sort').addEventListener('change', () => load());
  document.getElementById('clear').addEventListener('click', () => {
    document.getElementById('q').value = '';
    load();
  });

  // initial
  load();
</script>
{% endblock %}