{# html-validate-disable-next non-document-content-before-doctype #}
{%- extends "layout.html" -%}

{% block title %}Tribes • Tribal Connect Hub{% endblock %}

{% block head %}
<style>
  .item-list { list-style:none; padding:0; margin: 1rem 0; }
  .item { padding: .75rem 0; border-bottom: 1px solid #eee; }
  .item-link { text-decoration:none; color:inherit; }
  .item-desc { color:#444; margin:.25rem 0; }
  .badges { display:flex; gap:.35rem; flex-wrap:wrap; margin-top:.25rem; }
  .badge { background:#f3f4f6; color:#111; border-radius: 999px; padding:.15rem .5rem; font-size:.8rem; }
  .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .muted { color:#666; font-size:.9rem; }
</style>
{% endblock %}

{% block content %}
<section class="tribes" role="region" aria-labelledby="tribe-title">
  <h2 id="tribe-title" class="h4">Participating Tribes</h2>
  <p class="text-muted">Browse participating tribes and view public info.</p>

  <div class="toolbar">
    <div>
      <label class="visually-hidden" for="q">Search tribes by name</label>
      <input id="q" type="text" class="form-control" placeholder="Search by name…" aria-label="Search tribes by name">
    </div>

    <div>
      <label class="visually-hidden" for="sort">Sort tribes</label>
      <select id="sort" name="sort" class="form-select" aria-label="Sort tribes">
        <option value="name_asc">Sort: Name (A→Z)</option>
        <option value="name_desc">Sort: Name (Z→A)</option>
        <option value="established_desc">Sort: Established (newest)</option>
        <option value="established_asc">Sort: Established (oldest)</option>
      </select>
    </div>

    <button id="clear" type="button" class="btn btn-outline-secondary">Clear</button>
    <span id="status" class="text-muted" role="status" aria-live="polite"></span>
  </div>

  <ul id="list" class="item-list"><li class="muted">Loading…</li></ul>
</section>
{% endblock %}

{% block scripts %}
<script>
  const fmt = (s) => s ? s.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase()) : '';
  let TRIBES = [];

  async function load(){
    const list = document.getElementById('list');
    const status = document.getElementById('status');
    list.innerHTML = '<li class="muted">Loading…</li>';
    if (status) status.textContent = '';

    try {
      const q = (document.getElementById('q')?.value || '').trim();
      const sort = document.getElementById('sort')?.value || 'name_asc';

      const params = new URLSearchParams();
      if (q) params.set('q', q);
      params.set('sort', sort);
      params.set('limit', 500);

      const r = await fetch(`/api/core/tribes?${params.toString()}`);
      if (!r.ok) throw new Error('Failed to load tribes');
      TRIBES = await r.json();

      render();
      if (status) status.textContent = `${TRIBES.length} tribe${TRIBES.length===1?'':'s'} found`;
    } catch (e) {
      list.innerHTML = `<li class="text-danger">Error: ${e.message}</li>`;
    }
  }

  function render(){
    const list = document.getElementById('list');
    if (!Array.isArray(TRIBES) || TRIBES.length === 0) {
      list.innerHTML = '<li class="muted">No tribes found.</li>';
      return;
    }

    list.innerHTML = TRIBES.map(t => `
      <li class="item">
        <a class="item-link" href="/tribes-html/${t.id}">
          <strong>${t.name}</strong>
        </a>
        ${t.description ? `<div class="item-desc">${t.description}</div>` : ``}
        <div class="badges">
          ${t.recognition_type ? `<span class="badge">${fmt(t.recognition_type)}</span>` : ``}
          ${t.established_year ? `<span class="badge">Est. ${t.established_year}</span>` : ``}
        </div>
      </li>
    `).join('');
  }

  document.getElementById('q')?.addEventListener('input', load);
  document.getElementById('sort')?.addEventListener('change', load);
  document.getElementById('clear')?.addEventListener('click', () => {
    const q = document.getElementById('q'); if (q) q.value = '';
    load();
  });

  load();
</script>
{% endblock %}
{# html-validate-disable-next non-document-content-after-html #}