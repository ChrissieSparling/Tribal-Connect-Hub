{% extends "base.html" %}

{% block title %}Businesses · TribalConnect{% endblock %}

{% block head_extra %}
<style>
  .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.5rem 0}
  .grid{display:grid;grid-template-columns: repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:1rem}
  .card{border:1px solid #eee;border-radius:10px;padding:12px;background:#fafafa}
  .muted{color:#666}
  .badge{background:#eef;border-radius:999px;padding:.15rem .5rem;font-size:.8rem;margin-right:.35rem}
  .logo{width:100%;aspect-ratio:16/9;object-fit:contain;background:#fff;border:1px solid #ddd;border-radius:8px}
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">Native Businesses</h1>
<p class="muted">Discover Native-owned shops and services. Filter by tribe or category.</p>

<div class="toolbar">
  <select id="tribe"></select>
  <select id="category"></select>
  <input id="q" type="text" placeholder="Search name/description…">
  <label><input id="featured" type="checkbox"> Featured</label>
  <label><input id="active" type="checkbox" checked> Active only</label>
  <button id="clear" type="button">Clear</button>
  <span id="status" class="muted"></span>
</div>

<div id="grid" class="grid"><div class="muted">Loading…</div></div>
{% endblock %}

{% block scripts %}
<script>
const fmt = (s)=> s ? s.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()) : '';
async function loadTribes(){
  const sel=document.getElementById('tribe');
  sel.innerHTML='<option value="">All Tribes</option>';
  const r=await fetch('/api/core/tribes?limit=500&sort=name_asc');
  if(!r.ok) return;
  const rows=await r.json();
  for(const t of rows){
    const o=document.createElement('option');
    o.value=t.id; o.textContent=t.name; sel.appendChild(o);
  }
}
async function loadCategories(){
  const sel=document.getElementById('category');
  sel.innerHTML='<option value="">All Categories</option>';
  const r=await fetch('/api/core/business_categories');
  if(!r.ok) return;
  const rows=await r.json();
  for(const c of rows){
    const o=document.createElement('option');
    o.value=c.id; o.textContent=c.label; sel.appendChild(o);
  }
}
async function loadBusinesses(){
  const grid=document.getElementById('grid');
  const status=document.getElementById('status');
  grid.innerHTML='<div class="muted">Loading…</div>'; status.textContent='';
  const qs=new URLSearchParams();
  const tribe=document.getElementById('tribe').value;
  const cat=document.getElementById('category').value;
  const q=document.getElementById('q').value.trim();
  const featured=document.getElementById('featured').checked;
  const active=document.getElementById('active').checked;
  if(tribe) qs.set('tribe_id',tribe);
  if(cat) qs.set('category_id',cat);
  if(q) qs.set('q',q);
  if(featured) qs.set('featured','true');
  qs.set('active',active ? 'true' : 'false');
  qs.set('limit','100');
  const r=await fetch('/api/core/businesses?'+qs.toString());
  if(!r.ok){ grid.innerHTML='<div class="muted" style="color:#b00020">Failed to load</div>'; return; }
  const rows=await r.json();
  if(rows.length===0){ grid.innerHTML='<div class="muted">No businesses match.</div>'; return; }
  grid.innerHTML = rows.map(b=>`
    <div class="card">
      ${b.logo_url ? `<img class="logo" src="${b.logo_url}" alt="">` : ``}
      <h3 style="margin:.4rem 0 0">${b.name}</h3>
      ${b.description ? `<div class="muted" style="margin:.25rem 0">${b.description}</div>` : ``}
      <div style="margin:.25rem 0">
        ${b.storefront_url ? `<a href="${b.storefront_url}" target="_blank" rel="noopener">Shop</a>` : ``}
        ${b.website_url ? (b.storefront_url ? ' · ' : '') + `<a href="${b.website_url}" target="_blank" rel="noopener">Website</a>` : ``}
      </div>
      <div class="muted">
        ${b.email ? `${b.email}` : ``} ${b.phone ? (b.email? ' · ':'')+b.phone : ``}
      </div>
      <div style="margin-top:.25rem">
        ${b.is_featured ? `<span class="badge">Featured</span>`:``}
        ${b.visibility && b.visibility!=='public' ? `<span class="badge">${fmt(b.visibility)}</span>`:``}
      </div>
    </div>
  `).join('');
}
['tribe','category','q','featured','active'].forEach(id=>{
  document.addEventListener('change',e=>{ if(e.target.id===id) loadBusinesses(); });
  document.addEventListener('input',e=>{ if(e.target.id===id) loadBusinesses(); });
});
document.getElementById('clear').addEventListener('click',()=>{
  document.getElementById('tribe').value='';
  document.getElementById('category').value='';
  document.getElementById('q').value='';
  document.getElementById('featured').checked=false;
  document.getElementById('active').checked=true;
  loadBusinesses();
});
(async function init(){
  await Promise.all([loadTribes(), loadCategories()]);
  await loadBusinesses();
})();
</script>
{% endblock %}